<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CVS to Json</title>
    <script src="../../lib/jquery.min.js" type="text/javascript"></script>
</head>
<body>

    <div style="float:left;"><div>CSV:</div><textarea id="t1" style="height:400px;width:200px;" onpaste="convert();return true;"></textarea></div>
    <div style="float:left;width:210px;height:400px;">
        <p></p>
        <div style="vertical-align: middle;text-align: left;">
            <div style="text-align: left;width:200px;">
                <label><input id="r1" name="r" type="radio" value="map" checked="checked" />[{name:'aa',value:33}]</label>
                <label><input id="r2" name="r" type="radio" value="array" />[12, 34, 23]</label>
            </div><br />
            <div style="height:50px;width:200px;text-align:center;"><button onclick="convert();">转换</button></div>
            <div style="height:50px;width:200px;text-align:center;">
                <button onclick="save();">保存</button>
            </div>
        </div>
    </div>
    <div style="float:left;"><div>JSON:</div><textarea id="t2" style="height:400px;width:400px;"></textarea></div>
</body>
</html>
<script type="text/javascript">
    var regNum = /^\d+(\.\d+)?$/, varMap = {};
    function save(){
        var v2 = $("#t2").val();
        if(v2 == ''){
            convert();
            v2 = $("#t2").val();
        }
        var fname = 'test.json';
        if (isIE()){
            var winname = window.open('', '_blank', 'top=10000');
            winname.document.open('text/html', 'replace');
            winname.document.writeln(v2);
            winname.document.execCommand('saveas','',fname);
            winname.close();}
        else{
            saveByBrowse($("#t2")[0],fname);
        }
    }
    function saveByBrowse(obj,filename){
        var a=document.createElement('a');
        a.setAttribute('href','data:text/html;utf-8,'+obj.value);
        a.setAttribute('download',filename);
        a.setAttribute('target','_blank');
        a.style.display="none";
        obj.parentNode.appendChild(a);
        a.click();
    }
    function isIE(){
        if(!!window.ActiveXObject || "ActiveXObject" in window)
            return true;
        else
            return false;
    }
    function convert(){
        var v1 = $("#t1").val(), tp = get_type(), v2 = '';
        if(v1 == '' || tp == '')
            return;
        var d = csv_arr(v1);
        var s = ['['];
        window['cv_'+tp](d, s);
        s.push(']');
        v2 = s.join('');
        $("#t2").text(v2);
    }
    function get_type(){
        var rs = document.getElementsByName("r");
        for(var i = 0; i < rs.length;  i++){
            if(rs[i].checked)
                return rs[i].value;
        }
        return '';
    }
    function to_valstr(o){
        if(o.length <= 0)
            return '\"\"';
        if(o.length == 2)
            return to_var(o[1], 1);
        else{
            var ss = '';
            for(var i =1; i < o.length; i++){
                ss += ",\"" + o[i] + "\"";
            }
            return '[' + ss.substr(1) + ']';
        }
    }
    function to_var(v, i){
        if(varMap[i]){
            if(varMap[i]=='n')
                return v;
            else
                return "\"" + v + "\"";
        }
        if(regNum.test(v)){
            varMap[i] = 'n';
            return v;
        }else{
            varMap[i] = 's';
            return "\"" + v + "\"";
        }
    }
    function cv_array(a, s){
        a.forEach(function(o,i){
            if(!o[0])
                return false;
            if(i>0)
                s.push(',\n');
            s.push(to_valstr(o));
        });
    }
    function cv_map(a, s){
        a.forEach(function(o,i){
            if(!o[0])
                return false;
            if(i>0)
                s.push(',\n');
            s.push('{\"name\":\"', o[0], '\",\"value\":', to_valstr(o), '}');
        });
    }
    function csv_arr(v, spt){
        var arr = [], spt = spt || /\t/;
        var ds = v.split("\n");
        for(var i=0;i< ds.length;i++){
            var a = ds[i].split(spt);
            arr.push(a);
        }
        return arr;
    }
</script>